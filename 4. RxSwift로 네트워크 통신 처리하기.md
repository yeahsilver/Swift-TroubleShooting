# RxSwiftë¡œ ë„¤íŠ¸ì›Œí¬ í†µì‹  ì²˜ë¦¬í•˜ê¸° (Solved)

<aside>
ğŸ’¡ RxSwiftë¡œ ë„¤íŠ¸ì›Œí¬ í†µì‹  ì²˜ë¦¬í•˜ê¸°

</aside>

**ëª©ì **

í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬ëŠ” ë™ê¸°í˜• + URLSessionìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ìˆëŠ” ìƒíƒœ

í•´ë‹¹ ë°©ì‹ì„ ë¹„ë™ê¸°í˜•ìœ¼ë¡œ ì²˜ë¦¬ â‡’ RxSwift ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸°í˜• ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬ ì§„í–‰ ì˜ˆì •

ë„¤íŠ¸ì›Œí¬ì—ì„œ ë°›ì•„ì˜¤ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬ ë“±ì„ ì˜ í•´ì•¼ì§€ë§Œ ì¢€ ê´œì°®ì€ ì½”ë“œê°€ ë‚˜ì˜¬ ê²ƒ ê°™ì•„ì„œ ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬ ë¶€ë¶„ ë¦¬íŒ©í„°ë§ì„ ì§„í–‰í•´ì•¼ë¨.

[[iOS Swift] RxSwift ì™œ ì‚¬ìš©í•˜ë©´ ì¢‹ì„ê¹Œìš”?](https://medium.com/@jang.wangsu/ios-swift-rxswift-%EC%99%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EB%A9%B4-%EC%A2%8B%EC%9D%84%EA%B9%8C%EC%9A%94-5c9995f47bab)

**ê°œë°œ ìˆœì„œ**

---

### 1. ì˜¤ë¥˜ í…œí”Œë¦¿ ë§Œë“¤ê¸°

ì œë„¤ë¦­ í˜•íƒœì˜ ì—´ê±°í˜•(enum)ì„ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ í˜•íƒœê°€ ë“¤ì–´ì™€ë„ ì˜ ì²˜ë¦¬ë  ìˆ˜ ìˆë„ë¡ ì§„í–‰

```swift
enum NetworkResult<T> {
    case success(T)
    case requestErr(T)
    case pathErr
    case serverErr
    case networkFail
}
```

### 2. ë„¤íŠ¸ì›Œí¬ í†µì‹  ì½”ë“œ ì˜¤ë¥˜ í…œí”Œë¦¿ì— ë§ì¶°ì„œ ì§„í–‰í•˜ë„ë¡ ì²˜ë¦¬í•˜ê¸°

**ì´ì „ ì½”ë“œ**

URLSession ê¸°ë°˜ + ë™ê¸°ì²˜ë¦¬

escaping í´ë¡œì € ì‚¬ìš©í–ˆì§€ë§Œ, Dataì™€ Errorë°–ì— ë°›ì§€ ëª»í•œë‹¤ëŠ” í•œê³„.

- Path errorê°™ì€ ê²½ìš°ì—ë„ 200ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìŒ.

```swift
let url = URL(string: APIConstants.postLocationURL)
        
        var request = URLRequest(url: url!)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        let data = DailyPathRequest(user: uuid, timeSequence: timeSequence)
        
        let dictionary = data.toDictionary
        
        do {
            let httpBody = try JSONSerialization.data(withJSONObject: dictionary ?? [:])
        
            request.httpBody = httpBody
            
            let session = URLSession.shared
            session.dataTask(with: request) { data, response, error in
                if let data = data {
                    do {
                        let myResponse = response as! HTTPURLResponse
                        if myResponse.statusCode == 200 {
                            let decoder = JSONDecoder()
                            guard let decodedData = try? decoder.decode(GenericResponse<DailyPathResponse>.self, from: data) else { WolleyLog.error("path error")
                                return completion(error, [])
                            }
                            
                            return completion(nil, [decodedData.data])
                        } else {
                            return completion(error, [])
                        }
                    }
                }
            }.resume()
        } catch {
            WolleyLog.error(error)
        }
    }
```

**í˜„ì¬ ì½”ë“œ** 

```swift
// Service - API í†µì‹  ë¶€ë¶„
class SummaryService: SummaryServiceProtocol {
     func postDailyPath(uuid: String, timeSequence: [DailyPathTimeRequest], completion: @escaping((NetworkResult<Any>) -> Void)) {

         let url = URL(string: APIConstants.postLocationURL)

         var request = URLRequest(url: url!)
         request.httpMethod = "POST"
         request.setValue("application/json", forHTTPHeaderField: "Content-Type")

         let data = DailyPathRequest(user: uuid, timeSequence: timeSequence)

         let dictionary = data.toDictionary

        guard let httpBody = try? JSONSerialization.data(withJSONObject: dictionary ?? [:]) else { return }
         request.httpBody = httpBody

         let session = URLSession.shared
         session.dataTask(with: request) { [weak self] data, response, error in
             guard let response = response as? HTTPURLResponse else { return }
             guard let data = data else { return }
             guard let self = self else { return }
             completion(self.validateDailyPath(status: response.statusCode, data: data))
         }.resume()
     }

     private func validateDailyPath(status: Int, data: Data) -> NetworkResult<Any> {
         let decoder = JSONDecoder()
         guard let decodedData = try? decoder.decode(GenericResponse<DailyPathResponse>.self, from: data) else {
             WolleyLog.debug("POST daily/path >> ", "path error")
             return .pathErr
         }

         WolleyLog.debug("POST daily/path >> ", decodedData.responseMsg)

         switch status {
         case 200:
             return .success(decodedData.data)
         case 400..<500:
             return .requestErr(decodedData.responseMsg)
         case 500:
             return .serverErr
         default:
             return .networkFail
         }
     }
```

```swift
// View Model
func postDailyPath(uuid: String, timeSequence: [DailyPathTimeRequest], completion:  @escaping((NetworkResult<Any>) -> Void)) {
         service.postDailyPath(uuid: uuid, timeSequence: timeSequence) { networkResult -> Void in
             switch networkResult {
             case .success(let data):
                 completion(.success(data))
             case .requestErr(let message):
                 completion(.requestErr(message))
             case .pathErr:
                 completion(.pathErr)
             case .serverErr:
                 completion(.serverErr)
             case .networkFail:
                 completion(.networkFail)
             }
         }
```

ìŒ ê·¼ë° ì´ë ‡ê²Œ í•˜ë©´ API ëª…ì„¸ í•˜ë‚˜í•˜ë‚˜ validateë¥¼ ì²˜ë¦¬í•´ì¤˜ì•¼í•˜ë„¤??

ì½”ë“œì˜ ì¤‘ë³µì€ í´ë¦°ì½”ë“œì™€ëŠ” ë¨¼ ê²ƒ ê°™ìŒ!ì´ë¼ê³  íŒë‹¨ â‡’ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ë³´ì!

### 3.  network í†µì‹  í…œí”Œë¦¿ ë§Œë“¤ê¸° (Optional)

í…œí”Œë¦¿ì˜ í•„ìš”ì„±ì„ êº ë‹¬ì•˜ìœ¼ë‹ˆ ì´ì œ í…œí”Œë¦¿ì„ ì‘ì„±í•´ë³´ì.

ìŒ ê·¼ë° ë„¤íŠ¸ì›Œí¬ê°€ í†µì‹ í•˜ë ¤ë©´ ì–´ë–¤ ìš”ì†Œë“¤ì´ í•„ìš”í•˜ì§€?

- http method ì§€ì •
- http body ì¶”ê°€
- auth token ì¶”ê°€
- contenty type ì§€ì •
- í—¤ë” ì¶”ê°€

ì§€ê¸ˆ ìƒê°ë‚˜ëŠ” ê±´ ì´ì •ë„.

í•´ë‹¹ì˜ ê²ƒì„ ì¶”ê°€í•˜ê¸° ìœ„í•´ì„œ ì•„ë˜ì™€ ê°™ì´ URLRequestë¥¼ í™•ì¥ì‹œì¼œ ê°ê°ì— ëŒ€í•œ ë©”ì†Œë“œ êµ¬í˜„

```swift
extension URLRequest {
     enum ContentType {
         case json
     }

     enum HttpMethod: String {
         case GET
         case POST
     }

     func setHttpMethod(_ method: HttpMethod) -> Self {
         var request = self
         request.httpMethod = method.rawValue
         return request
     }

     func setHttpBody(_ body: Data) -> Self {
         var request = self
         request.httpBody = body
         return request
     }

     func setAuthToken(_ token: String) -> Self {
         var request = self
         request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
         return request
     }

     func setContentType(_ contentType: ContentType) -> Self {
         var request = self
         let value: String
         switch contentType {
         case .json:
             value = "application/json"
         }

         request.setValue(value, forHTTPHeaderField: "Content-Type")
         return request
     }

     func setHeader(_ key: String, _ value: String) -> Self {
         var request = self

         request.setValue(value, forHTTPHeaderField: key)
         return request
     }
```

### 4. RxSwift ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸°í˜• ë„¤íŠ¸ì›Œí‚¹ ì²˜ë¦¬ í•˜ê¸° + RxSwift Network í…œí”Œë¦¿ ë§Œë“¤ê¸° (Optional)

ìŒ ê·¸ëŸ¬ë©´ ë°ì´í„° í†µì‹ ì€ ì–´ë–»ê²Œ ì§„í–‰í•´ì•¼í• ê¹Œ...?

RxSwiftë¡œ ë¦¬íŒ©í„°ë§ì„ ì§„í–‰í•˜ë‹¤ë³´ë‹ˆ ì–´ë ¤ìš´ ë¶€ë¶„ì´ ë§ì•˜ë‹¤.

ê·¸ë ‡ì§€ë§Œ ë‚˜ëŠ” Combineì„ ì‚¬ìš©í•´ë³¸ ì ì´ ìˆê¸° ë•Œë¬¸ì— RxSwiftë„ ì–´ì°Œë˜ì—ˆë˜ ë¹„ë™ê¸° í”„ë¡œê·¸ë¨ì´ë¼ ë‹®ì€ ì ì´ ë§ì„ ê²ƒ ê°™ìŒ.

[https://github.com/presto95/Combine-RxSwift-ReactiveSwift](https://github.com/presto95/Combine-RxSwift-ReactiveSwift)

RxSwift - Combineì— ëŒ€í•œ ê³µí†µì ? ì‚¬ìš©ë°©ë²•?ì„ ì˜ ì •ë¦¬í•´ë†“ì€ ê¹ƒí—ˆë¸Œ ë°œê²¬! ì°¸ê³ í•´ë´ì•¼ì§€

[Combine-RxSwift-ReactiveSwift/Subject at master Â· presto95/Combine-RxSwift-ReactiveSwift](https://github.com/presto95/Combine-RxSwift-ReactiveSwift/tree/master/Subject)

íŠ¹íˆ Subject ë¶€ë¶„ì—ì„œ ë„ì›€ì„ ë§ì´ ë°›ì•˜ìŒ.

ì´ë ‡ê²Œ ì•ŒìŒì•ŒìŒ ê°œë°œí•˜ë‹¤ê°€ ë“œë””ì–´ ê´œì°®ì€(?) í…œí”Œë¦¿ ê°œë°œ ì™„ë£Œ! (~~ì•½ 4ì‹œê°„ ê±¸ë ¸..ë‹¤..~~)

validateí•˜ëŠ” ì½”ë“œë„ í•œë° ëª¨ì•„ ê°™ì´ ì²˜ë¦¬í•˜ì—¬ ë‚ ë ¤ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ë‹ˆ ì½”ë“œì˜ ì¤‘ë³µì„±ë„ í”¼í•  ìˆ˜ ìˆê³  ì•„ì£¼ ê´œì°®ì€ ì½”ë“œê°€ íƒ„ìƒí•œ ê²ƒ ê°™ë‹¤.

```swift
func toDataTask<Response: Decodable>() -> Observable<NetworkResult<Response>> {
         return Observable<NetworkResult<Response>>.create { observer in
             let task = URLSession.shared.dataTask(with: self) { data, response, error in
                 guard let response = response as? HTTPURLResponse,
                       let data = data
                 else { return }

                 WolleyLog.debug(Response.self, response.statusCode)

                 do {
                     let decoder = JSONDecoder()
                     let decodedData = try decoder.decode(GenericResponse<Response>.self, from: data)

                     WolleyLog.debug(Response.self, decodedData.responseMsg)

                     switch response.statusCode {
                     case 200:
                         observer.onNext(.success(decodedData.data!))

                     case 400..<500:
                         observer.onNext(.requestErr(decodedData.data!))

                     case 500:
                         observer.onNext(.serverErr)

                     default:
                         observer.onNext(.networkFail)

                     }
                 } catch {
                     observer.onNext(.pathErr)
                 }
             }

             task.resume()

             return Disposables.create(with: task.cancel)
         }
     }
```

í…œí”Œë¦¿ì„ ì™„ì„±í–ˆê³ , ì´ì œ í†µì‹  ë¶€ë¶„ì— ëŒ€í•œ ì˜ˆì „ ì½”ë“œì™€ í˜„ì¬ ì½”ë“œë¥¼ ë¹„êµí•´ë³´ì! 

ì–¼ë§ˆë‚˜ ì‚¬ìš©ì„±ì´ ì¢‹ì•„ì¡ŒëŠ”ì§€ ê°€ì‹œì ìœ¼ë¡œ í™•ì¸í•˜ê¸° ì¢‹ì€ ë°©ì‹ì´ë¼ê³  ìƒê°

ì°¸ê³ ë¡œ ê°™ì€ ê¸°ëŠ¥ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì†Œë“œ

**ì´ì „ ì½”ë“œ**

```swift
let url = URL(string: APIConstants.postLocationURL)
        
        var request = URLRequest(url: url!)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        let data = DailyPathRequest(user: uuid, timeSequence: timeSequence)
        
        let dictionary = data.toDictionary
        
        do {
            let httpBody = try JSONSerialization.data(withJSONObject: dictionary ?? [:])
        
            request.httpBody = httpBody
            
            let session = URLSession.shared
            session.dataTask(with: request) { data, response, error in
                if let data = data {
                    do {
                        let myResponse = response as! HTTPURLResponse
                        if myResponse.statusCode == 200 {
                            let decoder = JSONDecoder()
                            guard let decodedData = try? decoder.decode(GenericResponse<DailyPathResponse>.self, from: data) else { WolleyLog.error("path error")
                                return completion(error, [])
                            }
                            
                            return completion(nil, [decodedData.data])
                        } else {
                            return completion(error, [])
                        }
                    }
                }
            }.resume()
        } catch {
            WolleyLog.error(error)
        }
    }
```

**í˜„ì¬ ì½”ë“œ**

```swift
func postDailyPath(uuid: String, timeSequence: [DailyPathTimeRequest]) -> Observable<NetworkResult<DailyPathResponse>> {
        let url = URL(string: APIConstants.postLocationURL)
        let data = DailyPathRequest(user: uuid, timeSequence: timeSequence)
        let dictionary = data.toDictionary
        
        let httpBody = try! JSONSerialization.data(withJSONObject: dictionary ?? [:])
        
        return URLRequest(url: url!)
                .setHttpMethod(.POST)
                .setContentType(.json)
                .setHttpBody(httpBody as Data)
                .toDataTask()
    }
```

ê¹”ë”.. ê·¸ ìì²´

### 6. ì½”ë“œê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œ?

ì½”ë“œì˜ ì¤‘ë³µì„±ë„ í”¼í•˜ê³  ê°„ê²°í•œ ì½”ë“œë¥¼ ì™„ì„±í•œ ê²ƒ ê°™ë‹¤.. ì„±ê³µ!ì´ë¼ê³  ìƒê°í–ˆìœ¼ë‚˜

ì‘ë™ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤... ë¬´ìŠ¨ ì¼ì´ì§€?

ë¼ê³  ìƒê°í•˜ë‹¤ê°€ Reactive ë°©ì‹ ê°™ì€ ê²½ìš°ëŠ” ì–´ë–¤ ê¸°ëŠ¥ì— ëŒ€í•œ ê²ƒì„ â€œêµ¬ë…â€í•˜ì§€ ì•Šìœ¼ë©´ ë°˜ì‘ ìì²´ë¥¼ ì•ˆí•œë‹¤ëŠ”ê²Œ ìƒê°ì´ ë‚¬ë‹¤.

ìŒ.. ê·¼ë° URLSessionì„ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•´ì„œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ êµ¬ë…í•´ì•¼í• ì§€ ê°ì´ ì¡íˆì§€ ì•Šì•˜ìŒ..

Observableì— ëŒ€í•œ ê²ƒì„ ì–´ë–»ê²Œ êµ¬ë…í•˜ë©´ ì¢‹ì„ê¹Œ?

ì‚´ì§ ê²°ì€ ë‹¤ë¥´ì§€ë§Œ... ì•„ë˜ì˜ ë§í¬ê°€ ì¡°ê¸ˆ ë„ì›€ì´ ë  ê²ƒ ê°™ë‹¤.

[RxSwift vs URLSession ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë¹„êµ](https://local-dev.tistory.com/entry/RxSwift-vs-URLSession-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%8B%A4%EC%9A%B4%EB%A1%9C%EB%93%9C-%EB%B9%84%EA%B5%90)

ì§€ê¸ˆê¹Œì§€ í•œ ì½”ë“œëŠ” êµ¬ë…ì´ ë˜ì—ˆì„ ë•Œ ì–´ë–¤ ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ â€œë°©ì¶œâ€í•  ê±´ì§€ì— ëŒ€í•œ ì½”ë“œë¥¼ ì‘ì„±í•œ ê²ƒì´ì—ˆë‹¤.

ê·¸ëŸ¬ë©´ ì§„í–‰í•´ì•¼í•˜ëŠ” ê²ƒì€?

ë°”ë¡œ ì–´ë–»ê²Œ í•´ë‹¹ ë°ì´í„°ë¥¼ ë°©ì¶œì‹œí‚¤ë„ë¡ ë§Œë“¤ê²ƒì¸ê°€!ì˜€ë‹¤.

ì°¸ê³ ë¡œ ì–´ë–¤ ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ë°©ì¶œí•  ê²ƒì¸ì§€ì— ëŒ€í•œ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤. (ìœ„ì˜ ì½”ë“œì™€ ë™ì¼)

```swift
func toDataTask<Response: Decodable>() -> Observable<NetworkResult<Response>> {
        return Observable<NetworkResult<Response>>.create { observer in
            let task = URLSession.shared.dataTask(with: self) { data, response, error in
                guard let response = response as? HTTPURLResponse,
                      let data = data
                else { return }
                
                WolleyLog.debug(Response.self, response.statusCode)
                
                do {
                    let decoder = JSONDecoder()
                    let decodedData = try decoder.decode(GenericResponse<Response>.self, from: data)
                    
                    WolleyLog.debug(Response.self, decodedData.responseMsg)
                    
                    switch response.statusCode {
                    case 200:
                        observer.onNext(.success(decodedData.data!))
                        
                    case 400..<500:
                        observer.onNext(.requestErr)
                        
                    case 500:
                        observer.onNext(.serverErr)
                        
                    default:
                        observer.onNext(.networkFail)
                        
                    }
                } catch {
                    observer.onNext(.pathErr)
                }
            }
            
            task.resume()
            
            return Disposables.create(with: task.cancel)
        }
    }
```

êµ¬ë…ì„ í•˜ë ¤ë©´ service â†’ view model â†’ view controllerë¡œ ì—°ê²°ì‹œì¼œì£¼ëŠ” ì½”ë“œê°€ í•„ìš”í• í…ë°

í•´ë‹¹ ë¶€ë¶„ì„ ì–´ë–»ê²Œ êµ¬í˜„í•˜ë©´ ë ê¹Œ?

ë¨¼ì € view modelì—ì„œ serviceì—ì„œ ë°›ì•„ì˜¨ ê°’ì„ ì²˜ë¦¬í•´ì£¼ë©´ ë  ê²ƒì´ë‹¤.

serviceì—ì„œ ë°›ì•„ì˜¨ ê°’ì„ êµ¬ë…í•˜ì—¬ piechartë¼ëŠ” publisherì— ë¿Œë ¤ì¤€ë‹¤.

```swift
func getPiechart(date: String) {
        service.getPiechart(date: date)
            .observe(on: MainScheduler.instance)
            .subscribe(onNext: { [weak self] result in
                self?.piechart.onNext(result)
                WolleyLog.debug("GET /piechart result >>", result)
                
            }, onError: { [weak self] error in
                self?.piechart.onError(error)
                WolleyLog.debug("Get /piechart error >>", error)
                
            }).disposed(by: disposeBag)
    }
```

ê·¸ë¦¬ê³  piechartë¼ëŠ” ìš”ì†Œì— ë°ì´í„°ê°€ ë“¤ì–´ê°€ë©´ 

view modelì—ì„œ piechartì˜ ê°’ì„ ë°›ì€ ê²ƒì„ ì¸ì§€í•˜ê³ ,

view controllerì—ì„œ ì•„ë˜ì™€ ê°™ì´ ê°’ì„ ë°›ì•„ í™”ë©´ ìƒì— ë°ì´í„°ë¥¼ ì¶œë ¥í•˜ë©´ ë  ê²ƒì´ë‹¤!

```swift
viewModel.piechart
            .observe(on: MainScheduler.instance)
            .subscribe(onNext: { [weak self] result in
                switch result {
                case .success(let data):
                    self?.dailyData = data
                    self?.summaryCollectionView.reloadData()
                case .requestErr:
                    self?.piechartErrorData()
                case .pathErr:
                    self?.piechartErrorData()
                case .serverErr:
                    self?.piechartErrorData()
                case .networkFail:
                    self?.piechartErrorData()
                }
            }, onError: { [weak self] result in
                self?.settingNetworkAlert()
                self?.piechartErrorData()
            }).disposed(by: disposeBag)
    }
```

í•´ë‹¹ ë°©ì‹ìœ¼ë¡œ ê°œë°œì„ ì§„í–‰í•˜ë‹ˆ ì„±ê³µì ìœ¼ë¡œ ì‘ë™ ì™„ë£Œ!
