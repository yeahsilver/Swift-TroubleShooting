# FCM을 이용하여 정확한 위치 정보 데이터 저장하기

담당자: ella Heo
태그: iOS

<aside>
💡 **엘라의 개발 탐험**

[위치 정보 기반으로 타이머를 설정하여 로컬 데이터베이스에 데이터를 저장할 수 있는 방법이 무엇일까?](https://www.notion.so/4f0afdf5d5d548ca86af90052cec3e7e) 

[Suspend시에 일정 시간이 지나면 앱의 연결이 끊긴다. 해당 방식을 해결할 수 있는 방법은?](https://www.notion.so/Suspend-8503fbcaec68487cb2961ff67c2444d1) 

[FCM을 이용하여 주기적으로 로케이션 데이터를 저장할 수 있는 방법은 무엇일까?](https://www.notion.so/FCM-6f05edceaf2343839c8445d5edbee5f5)

</aside>

📍**목차**📍

---

### 1. 개요

해당 문서는 iOS 환경에서 FCM을 활용하여 로컬 DB에 현재 위치를 저장하는 기능을 구현하기 위한 방식이 기재되어 있습니다. 덧붙여, 타이머를 걸어 데이터를 저장하기 위해 어떤 방식을 시도해보았고 실패하였는지, 그리고 해당 문제를 해결하기 위해 어떤 방식을 사용하였는지에 대해 작성되어 있습니다. 

### 2. 문맥

- 일반적으로 iOS에서 제공되는 위치 정보 데이터 관련 메소드 중 실시간 위치 추적에 대한 기능은suspend 시에 이루어지지 않기 때문에, 위치 추적에 정확도가 낮아진다는 문제가 존재하였고, 엘라는 해당 문제를 팀원들에게 공유하였습니다.
    
    ![스크린샷 2022-02-22 오전 1.39.51.png](FCM%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%206d7ad/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-02-22_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.39.51.png)
    
- 이후 엘라는 위치 추적 정확도를 높이기 위해서는 어떻게 해야할까? 라는 고민을 많이 하게 되었고, 아래의 링크를 통해 새로운 방식을 떠올려보았습니다.
    
    [Elegant Background Location Tracking Without Battery Consumption!](https://medium.com/@m.farhand/elegant-background-location-tracking-without-battery-consumption-2d2e07ad3d2e)
    
    - 위에서 제시한 방식은 silent notification 처리를 하고 시간에 맞춰 반복적으로 노티를 보내주면 해당 시간에 데이터를 저장할 수 있다고 합니다.
    - 여기서 silent notification을 전송하는 역할은 서버 측이였고, 서버 측에서 스케쥴러를 맞추어 시간에 맞춰 클라이언트에 notification을 전송하면 프론트 측에서 해당 notification을 수신 받아 데이터를 처리하는 방식이였습니다.
- 데이터의 정확성을 높이고 앱의 효율성을 높일 수 있는 좋은 방법이라는 생각이 들어, 열정 엘라는 다른 팀원들에게 아래와 같은 메시지를 보내며 저의 실험에 동참해줄 수 있을지 여부를 파악해보았고, 동참에 승인이 나, 백엔드 개발자인 **알파**와 함께 해당 부분 개발을 진행하였습니다.
    
    ![스크린샷 2022-02-27 오전 12.05.42.png](FCM%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%206d7ad/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-02-27_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.05.42.png)
    

### 3. 목표

- FCM을 활용한 위치 추적 방식은 이전에 구현한 위치 추적 방식을 보완하는 방법입니다.
    - 해당 방식은 30분에 한번씩 서버에서 silent notification을 전송하여 앱을 깨운 후 앱이 깨어났을 때 현재 위치를 저장해주는 로직으로 구성되어있습니다.
    - 해당 방식을 통해 위치 정보를 일정 시간동안 반복하여 정확하게 측정할 수 있고, 위치 정보를 통해 시간표의 인터벌 정보를 더욱 정확하게 생성할 수 있습니다.
- 해당 방식을 테스팅해보기 위해 아래와 같은 시나리오를 작성하여 해당 조건에 충족한다면 성공했다고 간주하였습니다.
    - 시나리오 1: 통신 시 제대로 silent notification이 오는지 확인
    - 시나리오 2: 1시간에 2번 장소가 저장되는지 확인

### 4. 시도한 (실패) 방법 및 해당 기술 구현이 어려운 이유

- 처음으로 로컬에서도 타이머를 작동시키는 방식이 존재하여 사용자가 머물러 있던 장소에서 벗어나면 해당 방식으로 타이머를 작동하는 방식으로 구현해보았습니다. (5분에 하나씩 작동하는 방식)
    
    ```swift
    func calculateFiveMinutes() {
            timer = Timer.scheduledTimer(withTimeInterval: 60*5, repeats: false) { [weak self] timer in
                #if DEBUG
                self?.notification(body: "\(String(describing: self?.getCurrentTime())): 5분동안 움직이지 않는 중입니다")
                #endif
                
                self?.saveLocation()
            }
        }
    ```
    

- 해당 방식은 머문 장소에서 나온 것을 감지하게 되면, 타이머를 걸어 계속 이동할 시에는 타이머를 deinit 시키고, 이동하지 않을 경우 5분을 세어 5분이 지난다면 데이터를 저장하는 방식이었습니다.
    
    ```swift
    /// 새로운 장소에 진입했을 경우 새 장소를 모니터링하는 함수입니다.
    func locationManager(_ manager: CLLocationManager, didDetermineState state: CLRegionState, for region: CLRegion) {
        switch state {
            case .inside:
                WolleyLog.debug("inside")
                break
                
            case .outside:
                WolleyLog.debug("outside")
                saveLocation()
                stopMonitoringLocation()
                startMonitoringLocation()
                break
                
            case .unknown:
                break
        }
    }
    
    /// 타이머를 deinit 시키는 함수입니다.
    func deinitTimer() {
        if timer?.isValid != nil {
            timer?.invalidate()
        }
    }
    ```
    
- 아래의 링크로 오시면 엘라의 당시 고민 흔적을 관찰해보실 수 있습니다.
    - [위치 정보 기반으로 타이머를 설정하여 로컬 데이터베이스에 데이터를 저장할 수 있는 방법이 무엇일까?](https://www.notion.so/4f0afdf5d5d548ca86af90052cec3e7e)
- 해당 방식으로 구현한 결과 Foreground/Background 모드에서는 정상적으로 작동이 되었습니다.
- 하지만 suspend 상태에서 5분 타이머가 종료된 뒤 실행이 되어야하는 메소드가 실행이 되지 않았습니다.
- 그 이유는 5분이 지나기 전에 OS 측에서 해당 앱의 모든 메모리 자원을 해제시켜 해당 함수가 실행되지 않았던 것이였습니다.
    - iOS 앱의 생명주기에 따르면, 메모리 공간을 확보하기 위해 suspend 상태의 앱을 사용 빈도가 가장 적은 순서부터 메모리를 자동으로 해제시킵니다.
        
        ![스크린샷 2022-02-27 오후 5.41.27.png](FCM%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%206d7ad/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-02-27_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.41.27.png)
        
- 해당 이유로 인해, 로컬에서 타이머를 사용하여 위치 데이터를 저장하는 방식이 작동하지 않는다는 것을 확인하였고, 해당 방식을 구현할 수 있는 방법을 서치해보았습니다.
- 서치 중, 첫번째 링크를 발견하게 되었고, 첫번째 링크에서 엘라가 구현하고 싶은 기능들에 대한 설명이 나와있었지만 레거시 코드라 현재에는 작동하지 않는 메소드들이였습니다.
    
    (아래의 페이지는 레거시 코드를 Swift로 번역하여 정리한 페이지입니다.)
    
    [Suspend시에 일정 시간이 지나면 앱의 연결이 끊긴다. 해당 방식을 해결할 수 있는 방법은?](https://www.notion.so/Suspend-8503fbcaec68487cb2961ff67c2444d1) 
    
- 레거시 코드를 Swift 코드로 번역하다 setMinimumBackgroundFetchInterval라는 메소드를 발견하였는데, 해당 메소드가 현재 deprecated된 메소드여서 사용할 수 없었습니다.
- 그래서 타이머를 작동 시킬 수 있는 방식은 서버에서 디바이스를 깨우는 방식밖에 없다고 생각이 들었고, 해당 방식을 구현하기 위해서는 Silent Notification을 처리하여야 한다는 결론이 나왔습니다.

### 5. 해결 방식

- Silent Notification을 구현하기 위해서 Firebase Cloud Message(FCM)을 사용하였습니다.
- Silent Notification 처리를 진행한 뒤, 시간에 맞춰 반복적으로 노티를 보내주면 그 때 위치 정보 데이터를 저장하는 방식으로 구현하였습니다.
- Remote Notification 세팅 방식은 아래 페이지에 자세히 기재되어있습니다.
    
    [FCM을 이용하여 주기적으로 로케이션 데이터를 저장할 수 있는 방법은 무엇일까?](https://www.notion.so/FCM-6f05edceaf2343839c8445d5edbee5f5) 
    
- 해당 환경을 구축해 놓은 뒤, 몇가지의 시나리오를 작성하여 빠르게 테스팅을 위해 silent notification을 실행시켜보았고, 처음에는 아주 성공적으로 실행이 완료되었습니다.
    
    (페이지로 이동하시면 시나리오 및 해당 기능에 대한 결과를 볼 수 있습니다.)
    
    [위치 추적 시나리오](https://www.notion.so/16b8801a0d1b41528342bff7a07f27e2) 
    
- 하지만 시간이 지나고 보니 해당 방식이 작동하지 않는 것을 확인하였습니다.
- 이유를 찾아보니 **7. 주의사항-두번째 주의사항**에 대한 상황이 발생하였기 때문이었습니다.  (빠르게 테스팅 하려고 30초에 하나씩 보내고 했던게 원인이였습니다....)
- 그래서 알파와 엘라의 테스트 기기에서는 더이상 silent notification 테스팅을 할 수 없었고 한번의 좌절을 맛보았습니다.
- 하지만 여기서 포기할 알파와 엘라가 아니였습니다. 같은 팀원인 사브레의 디바이스를 빌려 테스트를 계속하여 진행해보았습니다.
    
    (페이지로 이동하시면 시나리오 및 해당 기능에 대한 결과를 볼 수 있습니다.)
    
    [BE → FE Notification 시나리오 테스트](https://www.notion.so/BE-FE-Notification-ae133d2c7dc74f989f4a2cd2e19d21b6) 
    
- 시나리오 1에 대한 부분에서는 모두 잘 처리가 되었지만, 시나리오 2에서 suspend 상태에서 처리가 되지 않는 것을 확인할 수 있었습니다.
- 해당 부분은 **7. 주의사항 - 첫번째 주의사항**에 대한 상황이 발생하였던 것이기에, OS에서 처리해놓은 기술을 제 스스로 변경하기란 어렵다는 판단을 내리게 되었습니다.
- 여기서 다행인 부분은 foreground, backgroud 모드에서는 잘 실행이 된다는 것이었습니다. 해당 부분에 대해서만 보정이 잘 이루어져도 사용자에게 더 나은 interval을 제공할 수 있을 것이라고 생각하였고, 해당의 이유로 일부 성공적으로 진행하였다고 생각하게 되었습니다.

### 6. 주의 사항

Apple Developer의 글에 따르면 몇가지의 주의사항이 있습니다.

첫번째 주의사항은 Silent Notification의 경우 Notification 중에서도 낮은 우선 순위를 가지고 있기 때문에, 서비스가 해당 Notification을 보낼지에 대한 여부가 보장되어 있지 않다고 합니다. 

두번째 주의사항은 Silent Notification은 또한 상황에 따라 작동되는 횟수가 있는데, silent notification이 실행되는 해당 횟수(몇번인지는 정확하게 기재되어있지 않음)를 초과한다면, 해당 디바이스에서 silent notification 실행 자체를 차단시켜버립니다.

해당의 이유로 1시간에 2~3번만 보내는 방식을 권장하고 있습니다.

![스크린샷 2022-02-22 오후 6.43.08.png](FCM%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%206d7ad/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-02-22_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.43.08.png)

### 7. 느낀점

Suspend 시 위치 추적 및 해당 실험을 통해 애플 OS단에서 작동하지 않는 기술이 무엇인지 조금 더 파악할 수 있었고, 이후 개발할 때 OS가 제공하지 않는 부분에 대해 조금 더 고려할 수 있는 현실적인 개발자가 되었다는 생각이 들게 해주었던 아주 의미있는 기능 구현이었습니다.
